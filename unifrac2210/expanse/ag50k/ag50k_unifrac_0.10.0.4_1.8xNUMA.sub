#!/bin/bash
#SBATCH --account=DDP414
#SBATCH --partition=ind-compute
#SBATCH -t 16:00:00
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=128
#SBATCH --mem=249325M
#SBATCH --export=ALL
hostname
lscpu
env
echo "=============="
cd /home/sfiligoi/unifrac
source setup_conda.sh
conda activate unifrac-0.10.0
conda list
echo "=============="
md5sum ag_emp.tre
md5sum ag_emp_even500.biom
dc=16
ds=1566
# compute onl 1/4th
smax=12524

for ((i=0; $i<8; i=$i+1)); do
  rm -f a_c0_${i}.out
done
echo "=============="
t1=`date +%s`
for ((i=0; $i<8; i=$i+1)); do
  let s1=${i}*${ds}
  let s2=${s1}+${ds}
  if [ ${s2} -gt ${smax} ]; then
    s2=${smax}
  fi
  let c1=${i}*${dc}
  let c2=${c1}+${dc}-1
  
  echo "Launching weighted_normalized ${s1} ${s2} using cores ${c1}-${c2}"
  taskset -c ${c1}-${c2} ssu -n ${dc} -f -m weighted_normalized -i ag_emp_even500.biom -t ag_emp.tre --mode partial --start ${s1} --stop ${s2} -o ./a_0_${i}.out &
done
wait
t2=`date +%s`
let dt=${t2}-${t1}
echo "ssu 1/4 took ${dt} seconds"

ls -l a_c0_?.out
md5sum a_c0_?.out

